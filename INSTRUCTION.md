# Dialogoi â€• ãƒ•ã‚§ãƒ¼ã‚º 1 ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

> **å¯¾è±¡ç¯„å›²** FlexSearch ã ã‘ã‚’ç”¨ã„ãŸ Retrieval-Augmented Generation (RAG) ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã€‚
> æœ¬æ›¸ã¯ãƒ•ã‚§ãƒ¼ã‚º 2ï¼ˆQdrant ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼‰é–‹å§‹ã¾ã§ã® **å˜ä¸€ã®ä¿¡é ¼ã‚½ãƒ¼ã‚¹** ã¨ã™ã‚‹ã€‚

---

## 1 é«˜ãƒ¬ãƒ™ãƒ«ç›®æ¨™

1. **å…¨æ–‡æ¤œç´¢ RAG MVP** - è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªã‹ã‚‰é–¢é€£ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ã‚¯ï¼ˆID ã¨ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼‰ã‚’è¿”ã™ã€‚
2. **å¤–éƒ¨ä¾å­˜ã‚¼ãƒ­** - Docker / GPU ã‚’ä¸€åˆ‡ä½¿ã‚ãš Node.js â‰¥ 20 ã ã‘ã§å‹•ä½œã€‚
3. **ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰** - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åæ˜ ã€‚
4. **å°†æ¥æ‹¡å¼µ** - å…¬é–‹ API ã‚’å›ºå®šã—ã€å¾Œã§ Qdrant ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å·®ã—è¾¼ã‚ã‚‹ã€‚

---

## 2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
flowchart TD
    A["watcher.ts(chokidar)"] -->|diff chunks| IDX["indexer.ts(FlexBackend)"]
    subgraph API Layer
      SR[search_rag.ts] -->|query| IDX
      SR -->|results| LLM
    end
```

- **`watcher.ts`** â€• ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã€‚è¿½åŠ  / å¤‰æ›´ / å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã€‚
- **`indexer.ts` / FlexBackend** â€• FlexSearch `WorkerIndex` ã‚’ç”Ÿæˆãƒ»ç¶­æŒã™ã‚‹ã€‚
- **`search_rag.ts`** â€• MCP ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦å…¬é–‹ã€‚`search_rag(query, k)` ã‚’æä¾›ã€‚

> **æ³¨** ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ `SearchBackend` æŠ½è±¡ã‚’ä»‹ã—ã¦å‘¼ã³å‡ºã™ã€‚ãƒ•ã‚§ãƒ¼ã‚º 2 ã§ `HybridBackend` ã‚’å·®ã—æ›¿ãˆã¦ã‚‚å‘¼ã³å‡ºã—å´ã¯ç„¡å¤‰æ›´ã€‚

---

## 3 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹         | èª¬æ˜                                                         |
| ---------- | ---------- | ------------------------------------------------------------ |
| `id`       | `string`   | `file::section::para-N::chunk-M[@hash]` â€• ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ„ã‚­ãƒ¼ |
| `title`    | `string`   | ç« ãƒ»ç¯€ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆé‡ã¿ä»˜ã‘ 3ï¼‰                                 |
| `content`  | `string`   | ãƒãƒ£ãƒ³ã‚¯æœ¬æ–‡ï¼ˆ200â€“400 ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰                             |
| `tags`     | `string[]` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ â€• ä¾‹: `ä¼ç·š:è¿½è·¡è£…ç½®`                             |

**FlexSearch è¨­å®šä¾‹**

```ts
profile: "fast",
document: {
  id: "id",
  index: [
     { field: "title",   tokenize: "forward", weight: 3 },
     { field: "content", tokenize: "reverse", weight: 1 }
  ],
  store: ["title", "content", "tags"]
}
```

---

## 4 ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸            | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€”                      |
| --------------------- | ---------- | ------------------------- |
| `flexsearch`          | ^0.7.0     | å…¨æ–‡æ¤œç´¢ (Worker ãƒ¢ãƒ¼ãƒ‰)  |
| `chokidar`            | ^3.5       | ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–              |
| `ts-node` / `esbuild` | latest     | dev ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  / ãƒãƒ³ãƒ‰ãƒ« |

Node 20 ä»¥ä¸Šã§ `worker_threads` ãŒæ¨™æº–åˆ©ç”¨å¯èƒ½ã€‚

---

## 5 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
Dialogoi/
â”œâ”€ src/
â”‚  â”œâ”€ backends/
â”‚  â”‚   â”œâ”€ SearchBackend.ts      # æŠ½è±¡ IF
â”‚  â”‚   â””â”€ FlexBackend.ts        # ãƒ•ã‚§ãƒ¼ã‚º1å®Ÿè£…
â”‚  â”œâ”€ tools/
â”‚  â”‚   â””â”€ search_rag.ts         # MCP ãƒ„ãƒ¼ãƒ«
â”‚  â”œâ”€ lib/
â”‚  â”‚   â”œâ”€ chunker.ts            # å†å¸°ãƒãƒ£ãƒ³ã‚¯åŒ–ãƒ˜ãƒ«ãƒ‘
â”‚  â”‚   â””â”€ watcher.ts            # chokidar ãƒ©ãƒƒãƒ‘ãƒ¼
â”‚  â””â”€ indexer.ts                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç®¡ç†
â”œâ”€ config/
â”‚  â””â”€ dialogoi.config.json
â””â”€ test/
   â””â”€ search_rag.spec.ts
```

---

## 6 ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### 6.1 èµ·å‹•æ™‚

1. `dialogoi.config.json` ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰ã€‚
2. `cache/index.json` ãŒå­˜åœ¨ã™ã‚Œã° `importIndex()`ã€‚
3. ç„¡ã‘ã‚Œã° **`*.md` / `*.txt`** ã‚’å…¨èµ°æŸ» â†’ `chunker.ts` â†’ `add()`ã€‚
4. åˆæœŸåŒ–å¾Œ `exportIndex()`ï¼ˆâ‰ˆ50 k ãƒãƒ£ãƒ³ã‚¯ã§ 3 ç§’æœªæº€ï¼‰ã€‚

### 6.2 ãƒ©ã‚¤ãƒ–æ›´æ–°

1. `watcher.ts` ãŒ FS ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã€‚
2. å·®åˆ†è¨ˆç®— â†’ è¿½åŠ ï¼å‰Šé™¤ãƒãƒ£ãƒ³ã‚¯ã‚’æŠ½å‡ºã€‚
3. Worker ã‚¹ãƒ¬ãƒƒãƒ‰ã§ `index.remove()` / `add()` ã‚’éåŒæœŸå®Ÿè¡Œã€‚
4. 1 ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã§ `exportIndex()` â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã€‚

### 6.3 ã‚¯ã‚¨ãƒª

```
search_rag(query, k) -> backend.search(query, k)
```

æˆ»ã‚Šå€¤:

```ts
{
  id: string,
  score: number,    // 0â€“1
  snippet: string,  // å‘¨è¾º 120 æ–‡å­—
  payload: { file, start, end, tags }
}
```

MCP ãƒ©ãƒƒãƒ‘ãƒ¼ãŒ Markdown `> å¼•ç”¨` ã«æ•´å½¢ã—ã¦ LLM ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æŒ¿å…¥ã€‚

---

## 7 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] **chunker.ts** â€• å†å¸°ãƒãƒ£ãƒ³ã‚¯åŒ– (è¦‹å‡ºã— â†’ æ®µè½) + 20 % ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ— âœ… **å®Œäº†**
- [x] **FlexBackend.ts** â€• Document Search API + export/importæ©Ÿèƒ½ âœ… **å®Œäº†**
- [ ] **indexer.ts** â€• ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç®¡ç†ã¨export/importæ©Ÿèƒ½ ğŸš§ **æ¬¡ã®ã‚¿ã‚¹ã‚¯**
- [ ] **search_rag.ts** â€• MCP ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦å…¬é–‹ ğŸ“‹ **äºˆå®š**
- [ ] **watcher.ts** â€• chokidarã‚’ä½¿ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦– ğŸ“‹ **äºˆå®š**
- [ ] **Unit tests** (vitest) â€• precision@k, hot-updateå‹•ä½œãƒ†ã‚¹ãƒˆ ğŸ“‹ **äºˆå®š**

### ç¾åœ¨ã®é€²æ—çŠ¶æ³ (2025-01-13)

**å®Œäº†æ¸ˆã¿:**

1. **chunker.tså®Ÿè£…** - MarkdownChunkingStrategy with 20% overlap, 25ãƒ†ã‚¹ãƒˆå…¨ã¦æˆåŠŸ
2. **FlexBackend.tså®Ÿè£…** - Document Search API, æ­£ã—ã„export/import, 28ãƒ†ã‚¹ãƒˆå…¨ã¦æˆåŠŸ

**æ¬¡ã®ã‚¿ã‚¹ã‚¯:** 3. **indexer.tså®Ÿè£…** - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç®¡ç†ã¨export/importæ©Ÿèƒ½

**æŠ€è¡“çš„ãªçŸ¥è¦‹:**

- FlexSearchã®Document Search APIã¯store: trueãŒå¿…é ˆ
- export/importã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Š (id, document) => void ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å½¢å¼
- TypeScriptå‹å®‰å…¨æ€§ã‚’'any'å‹ãªã—ã§ç¶­æŒ

---

## 8 è¨­å®šä¾‹

```json
{
  "vector": "none",
  "projectRoot": "./novels",
  "chunk": {
    "maxTokens": 400,
    "overlap": 0.2
  },
  "flex": {
    "profile": "fast",
    "exportPath": "./cache/index.json"
  },
  "search": {
    "defaultK": 10,
    "maxK": 50
  }
}
```

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§ã®ä¸Šæ›¸ãä¾‹ï¼š

```bash
npm run dev -- --project-root ./my-novels --max-tokens 300
```

---

## 9 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| æŒ‡æ¨™                              | ç›®æ¨™å€¤  |
| --------------------------------- | ------- |
| ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ (50 k ãƒãƒ£ãƒ³ã‚¯)  | < 3 ç§’  |
| ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«æ›´æ–° (1 ãƒ•ã‚¡ã‚¤ãƒ«) | < 50 ms |
| æ¤œç´¢ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· (k=10)             | â‰¤ 10 ms |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡                      | < 50 MB |

---

## 10 ãƒ•ã‚§ãƒ¼ã‚º2ãƒ•ãƒƒã‚¯ â€• HybridBackend ã‚¹ã‚±ãƒ«ãƒˆãƒ³

`backends/HybridBackend.ts` ã‚’è¿½åŠ ã— `SearchBackend` ã‚’å®Ÿè£…ã€‚Qdrant æœªèµ·å‹•æ™‚ã¯ä¾‹å¤–ã‚’æŠ•ã’ã€å‘¼ã³å‡ºã—å´ã§ FlexBackend ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

---

## 11 ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

| ç•¥å·   | æœŸé–“ (ç›®å®‰) | å†…å®¹                                            |
| ------ | ----------- | ----------------------------------------------- |
| **M1** | 1 æ—¥        | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆéª¨æ ¼ & è¨­å®šãƒ­ãƒ¼ãƒ€                   |
| **M2** | 3 æ—¥        | ãƒãƒ£ãƒ³ã‚¯åŒ– + ãƒ•ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ + search_rag åŸºç¤ |
| **M3** | 2 æ—¥        | ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦– & å¢—åˆ†æ›´æ–°                         |
| **M4** | 1 æ—¥        | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ & ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°                   |
| **M5** | 1 æ—¥        | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»CI è¿½åŠ                            |

> _ä¸Šè¨˜ã¯ AI ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ”¯æ´ã‚’å‰æã¨ã—ãŸä¿å®ˆçš„ãªè¦‹ç©ã‚‚ã‚Šã§ã™ã€‚_

---

## 12 Appendix â€• ã‚³ãƒãƒ³ãƒ‰

```bash
# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ (ts-node)
npm run dev

# ãƒ“ãƒ«ãƒ‰ & ãƒãƒ³ãƒ‰ãƒ« (esbuild â†’ dist/)
npm run build

# å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm t
```

---

_ãƒ•ã‚§ãƒ¼ã‚º 1 ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã“ã“ã¾ã§_
