# CLAUDE.md

このファイルは Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## 利用言語について

- ユーザとのコミュニケーションには日本語を使用してください
- コード中のコメントやテストケース名も可能な限り日本語でお願いします

## プロジェクト概要

Dialogoi は小説執筆支援のための RAG 搭載 MCP（Model Context Protocol）サーバーです。FlexSearch ベースの形態素解析検索により、小説プロジェクトの検索とファイル管理ツールを提供します。

**技術構成**: TypeScript + FlexSearch + kuromojin + MCP SDK  
**詳細仕様**: `INSTRUCTION.md` を参照

## 開発コマンド

### 基本開発

- `npm run dev` - tsx を使用して開発サーバーを起動
- `npm run build` - TypeScript を dist/ にビルド
- `npm run start` - dist/ からビルド済みサーバーを実行

### テストと品質管理

- `npm test` - vitest でテストを実行
- `npm run test:watch` - ウォッチモードでテストを実行
- `npm run lint` - ESLint チェック（警告0個を強制）
- `npm run typecheck` - TypeScript 型チェック
- `npm run format` - Prettier でコードをフォーマット
- `npm run format:check` - コードフォーマットをチェック

## 開発時の注意事項

- 全てのファイル操作は絶対パスを使用
- 小説プロジェクトには `novel.json` 設定ファイルが必要
- settings/contents ディレクトリはプロジェクト毎に設定可能
- DIALOGOI.md ファイルはプロジェクト固有の AI ガイドラインを提供
- サーバーは厳格な ESLint ルールを使用（警告0個必須）
- テストは vitest フレームワークを使用
- **ライブラリの動作に不明点があればまずは公式ドキュメントを調査すること**
  - 型定義だけでなく、公式ドキュメントやリポジトリの examples/ を確認
  - 特に FlexSearch、chokidar などサードパーティライブラリの適切な使用法を把握する
- テストのためにスクリプトを作成した場合、 git commit 前に削除すること
  - 機能が完成するまではテストスクリプトも削除せず残しておくこと
  - ユーザがテストを点検することができるように

## 開発の進め方

- 複数のフェーズに分かれている開発の場合は、フェーズが1つ終わるごとに必ず　lint, typecheck, test を行うこと
- そのフェーズで作成したファイルにはテストを書くこと
- lint, typecheck, test が通ったら git commit する

### コーディング規約と型安全性

**基本原則：** コーディング規約、型安全性についてはその言語のベストプラクティスに従うこと。敢えてベストプラクティスから外れる場合はその理由を明記すること。

**TypeScript 固有の注意事項：**

- `any` 型の使用は極力避ける（型安全性を損なうため）
- `unknown` や適切な型ガードを使用して型安全を保つ
- `as` キャストは最小限に留め、型の整合性を保証できる場合のみ使用
- 関数の戻り値型は明示的に指定する（推論に頼らない）
- `strict` モードを有効にしたまま開発する

**例外的な使用が許される場合：**

- サードパーティライブラリの型定義が不完全な場合
- 複雑な型変換で一時的な型キャストが必要な場合
- ただし、その理由をコメントで明記すること

## **重要：作業完了前の必須チェック**

**新しいファイルを作成・編集した後は、必ず以下のコマンドを実行してCIの通過を確保すること：**

1. `npm run lint` - ESLint チェック（警告0個必須）
2. `npm run format` - Prettier フォーマット
3. `npm run typecheck` - TypeScript 型チェック
4. `npm test` - 全単体テストの実行
5. `npm test:integration` - インテグレーションテストの実行

これらのチェックを怠ると GitHub Actions CI が失敗する。コミット前に必ず実行すること。
